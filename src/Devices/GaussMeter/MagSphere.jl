export MagSphere, MagSphereParams, MagSphereDirectParams, MagSphereDescriptionParams
abstract type MagSphereParams <: DeviceParams end

Base.@kwdef struct MagSphereDirectParams <: MagSphereParams
  portAddress::String
  bufferSize::Int64 = 2048
#  calib::Matrix{Float64}
  @add_serial_device_fields "\r\n"
end
MagSphereDirectParams(dict::Dict) = params_from_dict(MagSphereDirectParams, dict)

Base.@kwdef struct MagSphereDescriptionParams <: MagSphereParams
  description::String
  bufferSize::Int64 = 2048
#  calib::Matrix{Float64}
#  t::Int64
#  radius::typeof(1u"m")
#  sensorRotation::Matrix{Float64}
  @add_serial_device_fields "\r\n"
end

MagSphereDescriptionParams(dict::Dict) = params_from_dict(MagSphereDescriptionParams, dict)
# function MagSphereDescriptionParams(dict::Dict)

#   if haskey(dict, "calib")
#     # This into a function
#     calib = dict["calib"]
#     if calib isa String
#       # does file exist
      
#       # read file
#       calib = ...
#       dict["calib"] = calib
#     else 

#     end
#     # End function
#   else
#     dict["calib"] = ones(Float64, 86, 3)
#   end

#   return params_from_dict(MagSphereDescriptionParams, dict)
# end

struct MagSphereResult
  timestamp::Float64
  data::Array{typeof(1.0u"T")}
end

Base.@kwdef mutable struct MagSphere <: GaussMeter
  @add_device_fields MagSphereParams
  sd::Union{SerialDevice, Nothing} = nothing

  ch::Channel{MagSphereResult} = Channel{MagSphereResult}(1)
  task::Union{Nothing, Task} = nothing
  lock::ReentrantLock = ReentrantLock()
end

neededDependencies(::MagSphere) = []
optionalDependencies(::MagSphere) = [SerialPortPool]

function _init(gauss::MagSphere)
  params = gauss.params
  sd = initSerialDevice(gauss, params)
  @info "Connection to MagSphere established."        
  gauss.sd = sd
end

function initSerialDevice(gauss::MagSphere, params::MagSphereDirectParams)
  sd = SerialDevice(params.portAddress; serial_device_splatting(params)...)
  return sd
end

function initSerialDevice(gauss::MagSphere, params::MagSphereDescriptionParams)
  sd = initSerialDevice(gauss, params.description)
  return sd
end

take!(gauss::MagSphere) = isready(gauss.ch) ? take!(gauss.ch) : error("Empty channel")

function enable(gauss::MagSphere)
  lock(gauss.lock) do
    disable(gauss)
    gauss.ch = Channel{MagSphereResult}(gauss.params.bufferSize)
    gauss.task = Threads.@spawn readData(gauss)
    bind(gauss.ch, gauss.task)
  end
end

function disable(gauss::MagSphere)
  lock(gauss.lock) do
    try 
      close(gauss.ch)
      wait(gauss.task)
    catch e
      @error e
    end 
  end
end

function readData(gauss::MagSphere)
  discard(gauss.sd)
  while isopen(gauss.ch)

    # Sleep while channel is full
    while length(gauss.ch.data) >= gauss.ch.sz_max
      sleep(0.01)
    end

    try
      line = receive(gauss.sd)
      result = parseData(gauss, line)
      if !isnothing(result)
        put!(gauss.ch, result)
      end
    catch e
     @info e
    end
  end
end

function parseData(gauss::MagSphere, line::String)
  components = split(line, ";")
  # Unexpected format
  if length(components) != 259
    return nothing
  end

  timestamp = tryparse(Float64, components[1])
  isnothing(timestamp) && return nothing

  components = reshape(components[2:end], 3, 86)
  data = zeros(typeof(1.0u"T"), 3, 86)
  
  
  for (i, xyz) in enumerate(eachcol(components))
    xyz = tryparse.(Float64, xyz)
    data[:, i] = xyz./1e6 .* 1.0u"T"
  end
  #@info data

  coordinateTrafo = [0.012144557799139234 0.9446821032501379 -0.17666592995033067; -0.12921116728414878 -0.9680603730863849 0.04618383180229118; 0.24097471798287565 -0.9247819524510708 0.044025569788606424; -0.7093409050851258 -0.6425822365577403 0.27785607340900237; 0.7857406334841042 -0.6414272820499348 -0.026809812313397192; -0.5051515005777241 -0.7844850926365206 0.11218679320603209; 0.1277459026024351 -0.9959942883225541 0.1994484609171315; -0.6854099519272753 -0.6587205392077035 0.25149835199975057; -0.9614254962976959 0.17377633972158912 0.18673556197445954; 0.20303627021870593 1.0719428666187758 -0.14964006784672923; 0.9777763159828926 -0.02455262533317886 -0.16196446543693815; -0.8156293411079499 0.5733196413872765 0.07786580425483947; 0.15852132497334925 0.941659512615295 0.043613196605590966; -0.791253739403688 0.5887293810336957 0.15242231189187216; 0.43874183461170085 0.8813917258174828 -0.1355535860996155; -0.6580432003004312 -0.6461748306285278 0.29852367479483577; -0.5926807400603348 -0.7712363434210249 0.020018801978779123; -0.7207679431309627 0.6760496878915793 0.16571973171837734; -0.975421355601297 -0.05972178561139779 0.1421979348640095; 0.2619768972279408 0.9197644383163024 -0.18044309140786183; -0.31611612818901136 0.9840123834126697 0.026680062902762754; -0.5334732835324737 -0.8347481937706018 0.1856919345451118; 0.11781345150652639 -0.9329469971055077 0.12446808053203563; 0.5473370102913623 -0.8029820793934762 -0.0053398481265258075; 0.47677192267054913 0.8589541263272864 -0.07964252852360394; 0.9642217682121429 -0.21616933601111407 -0.1141551569342561; 0.797814314894279 0.4981359542352306 -0.24890876860209518; -0.9625656565879245 -0.07228331017222242 0.09782021991066227; -0.828106766994735 0.4758259837512554 0.1277361233081746; -0.9513923415754653 0.25266561244563757 0.24095006858355894; -0.7771665213089647 0.5839743102229263 0.07779080283657315; 0.2167303839802006 -0.9264773162821305 -0.10480646207128648; -0.17180023447238124 0.9808337626004233 0.08340529818584652; -0.7848506415323999 0.5483700183130216 0.06187812119062307; -0.8947088005001842 -0.19427062446065096 0.39981187073094876; 0.948979309495056 0.09807423535139298 -0.13978570542212715; -0.9670116221076381 -0.03868659790446384 0.16063629838011992; 0.573408111125575 -0.8402426308208626 -0.03094560302530169; 0.6126014665563347 -0.8797937047501356 0.017327702986974437; -0.9590459031147969 -0.05487692883322419 0.14811051123739846; -0.39777823863494144 0.8921488097440637 -0.03620722940336836; 0.6058323609334347 -0.762051362200856 -0.03389285145645948; 0.4024515613823809 0.8504872863869339 -0.2062367213704251; 0.0752515043180551 0.9857847468333338 -0.11020323338829853; -0.9506568019605672 -0.2598768865398471 0.12852401505524078; 0.6781275404639375 0.6700072126867997 -0.11271739196389846; 0.7326567889465969 0.6843988826236292 -0.1404117745045333; 0.9579314168270722 -0.04598701119222895 -0.1370695090608617; -0.7842202562579961 -0.4930930742968225 0.23447016132332943; -0.6748721978045095 0.7417444301842708 0.013732985226616179; -0.7024421211948584 -0.6649829828716473 0.19022998938279312; -0.8019201739834279 -0.5290048972752888 0.24067128432778648; 0.19995344586035052 0.9770889221406727 -0.19371588195746867; -0.9771483850550714 0.15217060341005792 0.08863448156024852; 0.2113749050326527 -0.9744336056181712 0.18180016643562535; 0.7011461627116711 0.6578554973205692 -0.26886354543349644; -0.8065716173910601 -0.5330957422309385 0.09146296301227426; -0.22208071222490128 -0.9766876407820512 0.20051501432836458; 0.35184823186427755 -0.9091244184115792 0.07044090164946241; -0.9114690043486046 0.05850571041051744 0.3211569390388005; -0.9107729396172112 0.019162418391329972 0.24794457941232084; -0.45571464148737717 0.8460999035993229 0.08506593854505165; -0.8240083369119572 -0.4445917007960276 0.20896243285220448; -0.9159187211716875 0.3037981594796802 0.16136073557611563; -0.5603135305945643 0.8017773640095569 0.09406652205226218; 0.9273398817358538 -0.2781944010353608 0.02308970463304004; -0.5569107760829762 0.8038718653682779 0.061415765248934884; -0.5152940754058682 0.8609693806989419 0.06448674506326224; 0.08637419796060479 0.9580351383945475 -0.2292719378895856; -0.8658292610097744 0.4385084062143252 0.06398739068512785; 0.10735142636359452 0.955942448339725 -0.1821123911698264; -0.8198815639683902 -0.3981375011744682 0.13815809585557332; 0.7046017434449613 0.7491772546442991 -0.13196553420514118; -0.8645251434692484 -0.4756078033840702 0.3121415008767716; -0.14047404655702594 0.9371667462654855 -0.11528426891034264; 0.34158709092478273 0.9086137418719845 -0.1539771039565196; -0.9014717711560071 0.3427946459423208 0.12594361352063466; -0.26219539587164575 0.9734788586569216 -0.11124833614980717; -0.869980934232795 0.4427581596801984 0.08969234748359682; -0.8757786716046427 0.38721535945654945 0.12006133546101355; -0.9218513990865808 -0.2516811242242089 0.3129549959968427; 0.2587345338861015 0.8907964977074161 -0.20838649429372375; -0.8374747084349191 -0.42344376924854926 0.2475275965979414; -0.8121187598119097 -0.48285878299161983 0.18670583318848588; -0.31702465586963413 0.9144156624511869 0.0012327378710468731; 0.23364318571106993 -0.9534426032710092 0.03223180606345926;;; -0.9297517731199479 0.05621749130448678 0.1454216571669889; -0.4163490065785179 0.012470885773031118 -0.870277001878507; -0.2159667799218431 -0.15553627568805448 -0.9447324142242085; 0.06808879299898862 0.3820341113559196 0.9129553038379459; 0.3103609794822888 0.44625604514392647 -0.7890143929936062; 0.30366561452122615 -0.08719918839612319 0.9666957138260106; -0.7880724884831708 -0.20415676083497294 -0.5679667424251056; 0.5852132708027731 -0.7100229103026837 -0.3049970767635729; -0.05924752092871218 0.4951642720878269 -0.8263371335509422; -0.6384363386832603 0.20496290244113805 0.67168872336475; -0.13979361259128653 0.49412542970845463 -0.8316592555594032; -0.03492681304945461 0.10913885037816484 -0.9693962418921007; 0.41617956568914966 -0.0357787796206326 -0.9353976767804673; 0.5358420679423131 0.7802815584578252 0.26161509863468296; -0.7856063557063335 0.3077006007557066 -0.5312053433084182; 0.5381745732591693 -0.25181499390431256 0.7656545224274182; -0.03742756102608169 0.027788432999545906 -0.94392507976491; 0.16228472127976729 0.3642827346203218 -0.8577108700119545; -0.11048737254179739 -0.3686552569091962 -0.886627551115398; 0.9047453010069654 -0.20325539489274574 0.4258521899970703; -0.21875569064417708 -0.061308240087240194 -0.999939653122924; 0.37868778598898695 -0.4409861749999616 -0.7835114479129949; 0.5561091092494244 0.1459526993698033 0.7834577298779396; 0.253041683462745 0.15690239736777023 -0.9089429257253273; 0.653945176435321 -0.36025720864203575 -0.5951864633189845; 0.24748132071541837 0.9484946318051571 0.22518574470421882; 0.6139736598849939 -0.7835240122443996 0.19635562055274788; -0.062266734359434577 -0.6833615086891124 -0.6678714826628093; 0.1328855527346745 -0.05177090616471642 0.9842529844782765; -0.22485965680815978 0.19940464034530514 -0.9639647820319303; 0.33553101412585895 0.6012604170825001 -0.7162286223563585; -0.5273981418774891 -0.07008749731403435 -0.8018165476212752; 0.7720131497748387 0.19785923587359777 -0.5966148801183838; -0.22710693491319633 -0.18433591720510834 -0.9426122571994974; -0.4076569949768113 0.2626536342554702 -0.8788398318061019; 0.030445329658590096 -0.8830761161993509 -0.4504512509444941; 0.11876980202140877 0.3811923165719996 0.8754981316545071; 0.2926877405298364 0.17434110620735818 0.9098233243235823; 0.7448221831486076 0.4198151653993316 0.44064050273308825; 0.16127961998876988 -0.17948865493576358 0.9248580182042904; 0.3570045740234597 0.11728573296973643 -0.885693429426311; 0.52726111857957 0.3579602621988338 0.7710835512774513; 0.33815904237353994 -0.30242545548613314 -0.867970921003522; 0.03690206846463446 -0.11639152082492264 -0.9600266225208646; 0.10823009674957534 -0.026152755249360275 0.96697597166514; -0.09407984621630067 0.30464902809110983 0.9347223864700376; 0.596361337866064 -0.37954822822444423 0.6491364755506083; 0.09639529730590767 -0.7385274381479542 0.6148201542366417; 0.39137143582976675 -0.2578700944680974 0.8412672907084721; 0.3041928600767474 0.281736689994006 0.8939136474779908; 0.62763437100402 -0.5989187247964727 0.3824785871515198; -0.15549119280969714 0.5876246683619298 0.7622344572653432; 0.16476787917585503 0.1685682927851025 0.9532970357477681; -0.21605488505371703 -0.8048879347667738 -0.5240671071916595; -0.9027179443653784 -0.24793952818507994 -0.2585763351921477; 0.40855975207291595 -0.06906253605153771 0.920744810697561; 0.23361899333395633 -0.1221541366284211 0.9830528017629221; -0.6496675756616117 0.03039985576226931 -0.7288105675483428; 0.48911297717764934 0.13497384752091243 -0.8426069706514623; -0.31296264703980486 -0.15235346009830447 -0.9227842104398369; 0.1856566699161407 0.6199805293684444 0.7006019654267631; -0.027493900921556347 0.1265524205750948 -1.0069467832267844; 0.0711584165940494 0.37119173268998695 0.9319208643397381; 0.1420827361626689 0.06831403158093069 0.9544736266635026; 0.6777512779378841 0.4378064860690411 0.559314757205445; 0.2467247277347808 0.7221853030986212 -0.544496421699227; 0.15277456598185102 0.006172969405272318 0.9615269018464908; -0.7213208812408434 -0.4454970326727389 0.49960520585319346; -0.34562334336302086 -0.19191827915774862 -0.899580140777504; 0.26389546414645904 0.40674098910792533 0.8566993609485143; -0.30613995128516447 0.23691453633667692 0.9082548902587211; 0.21673046240578478 -0.7561872213598689 -0.5686120386171147; 0.6532037637568137 -0.6697249761845482 -0.17558155644975365; 0.5358825795189489 -0.6254461576850288 0.5251394207228082; -0.8092688375625263 -0.15570874590515638 -0.5873704929051136; -0.5661457859358182 0.033535726231596445 -0.7998155445941805; -0.28163126754907164 -0.39112341542345247 -0.8888476103970291; -0.07043761416477241 0.09144753252406049 0.9797578500388181; -0.07230831500275961 -0.3272904213918613 0.9040916120280704; 0.34449791225067977 0.6819461209755803 0.6205461461127812; -0.3118754929206734 0.07376550074626516 -0.9651489430131184; -0.027682899505606318 -0.20834528816544445 -0.977870502080997; -0.19045520219088904 -0.2516153132824046 -0.9495377298971255; 0.09431481340324585 -0.4488698589042116 -0.8464568326907177; -0.9026974913897104 -0.30932866139697324 -0.16200779840820018; -0.25368654641680244 -0.1332319552494254 -0.9964169723985206;;; -0.2052002456049271 -0.15080331877342307 -0.9383441221500964; -0.8944451203811797 0.08408097934643227 0.41857867014860106; -0.9239402752861549 -0.22516271658946926 0.22569915364922438; 0.6776909071441202 -0.6747002934272432 0.23269885638718552; -0.5105006823299558 -0.6113375088161284 -0.5715994386535459; 0.7745940899837885 -0.5551459540097129 -0.31290704499242494; -0.5711209449880048 0.04388103165582642 0.7910642011604611; -0.4059796103286303 0.08839311745263591 -0.9116502814528066; 0.18986395636776748 0.847871271317754 0.4753127353979721; -0.6838222058882296 0.07887958556608791 -0.6999356316225197; -0.10851223284545411 -0.8451015933710645 -0.478290666810365; 0.5482728174029857 0.8015348945710286 0.07597115079539005; 0.9048418429183942 -0.13549781036809477 0.36894613305520446; -0.053460193974783056 -0.2540352329368931 0.9622816997104088; 0.4296148903813795 -0.26509613817955563 -0.8420126696577362; 0.41462270840543686 -0.7070470996699806 -0.5661540858125682; -0.7726391828966392 0.5684010525470987 0.0315508575882245; 0.6744278585955032 0.6111317676734564 0.4061172073241293; -0.13910369687917698 0.9101030071979277 -0.3636795637798692; -0.3320232063920236 0.25808718762376975 0.8641774739149647; 0.8986286487038618 0.2770820505653632 -0.25913520057151157; -0.7424744574827151 0.31149491172298827 -0.5712177958281501; 0.8200593068430061 -0.005586975658833256 -0.5424528014937292; -0.7800525438511731 -0.5127986128619227 -0.31862430197700486; 0.5654970000042621 -0.24721958571119107 0.7607852388233306; -0.025378033534766246 0.26615146780408533 -0.9777715844528526; 0.10114722187673106 0.30051002622338036 0.9536689529138588; -0.13012220585283896 0.6872214263268427 -0.6855089750205092; -0.5406262243365068 -0.8519786764525278 -0.012510799475889758; 0.2990891726836082 0.9384714751244733 0.14198297725468115; 0.423148527157567 0.5431823313263444 0.6942785781841391; -0.7888078557559834 -0.2596312330592272 0.5215041902141748; 0.5901951612472027 0.056520014931877076 0.8033535487077978; 0.5243384695050667 0.802741982476216 -0.2507299184594024; -0.10006005161126912 0.9205562375573652 0.2852772261047698; 0.18315600750018654 -0.4131205634154949 0.8698450143656548; 0.09464955598794084 -0.8970243648960278 0.3954391716975157; 0.7551358488795699 0.5189063128024749 -0.3702889824387088; 0.4134286128354662 0.24079016079319113 -0.8936500286243656; 0.019308483194094676 -0.9735485284176917 -0.17855274022257897; 0.8009345666964511 0.38399400082393625 0.4165809171840128; 0.599499883392716 0.42460177068129623 -0.6385606288180447; 0.8275862404586294 -0.275686744226535 0.3920961208761824; 0.9817572106342445 -0.042698036929246126 0.04436207809396917; 0.2461016071043394 -0.9554328578555095 -0.05481183534747389; -0.6389910516696117 0.6892472641992075 -0.29435821051388755; -0.38837103104784265 0.553653167850174 0.7279579994619243; 0.20386166883032575 0.6253844842958839 0.7104890321506022; 0.339058818980223 -0.8103592516117591 -0.4285353046433926; -0.6608074028901431 -0.622724686451214 0.4558838804925662; 0.14305273291556608 -0.4293257833482899 -0.883680035219726; 0.5216557003211365 -0.6203751111100476 0.535190129371553; -0.9369920854827675 0.25089111233653744 0.09166782983752207; -0.02689262657645172 0.5375148241150736 -0.8094455446106223; -0.3150663820756524 0.09570740886105415 0.9292849172691813; -0.5831156328565451 0.7454019770993572 0.310758709168425; 0.5044533660662217 -0.8147848469792368 -0.1963023566952364; -0.7438009086396196 0.28185654312226754 0.6021727408696645; -0.750351036785956 -0.3723065354225751 -0.5009915518550135; -0.012282879570612512 0.9677629968042534 -0.16696041945627874; 0.06793490640839649 -0.7676963605653033 0.6007226803976636; 0.8420373539580714 0.5096764192395132 0.0015550999417038808; 0.5197887485701203 -0.7799889588451286 0.3053823216144176; -0.33863478877613556 -0.8899724351324412 0.10302060537511917; -0.3973302402749019 -0.3925365222206594 0.8119528234189732; -0.09973304882714636 -0.5744975544875593 -0.8143973848711709; -0.7720352243082331 -0.5802332271097158 0.1938480864415198; -0.4943447946789684 -0.1707605912820957 -0.8316114343329826; 0.9266829841266219 -0.1818897271396583 -0.33516832118667195; -0.3593021917909443 -0.7591757740795683 0.5042319761679873; -0.9271254933178278 0.03198543055330791 -0.3294311474071339; -0.41887509900627906 0.44691265506468103 -0.7510534424270953; 0.23320326282136647 -0.032196750093159615 0.9578939109136518; 0.046746879846697995 -0.6279313656634188 -0.776038284017353; 0.5811197680530771 -0.018533916651943542 -0.8259006484599811; 0.7554209376309368 -0.35708518903904474 -0.5575328347379512; 0.239883813869021 0.8323110539321608 -0.49635820112500734; -0.9421787368718662 -0.21909403532474753 -0.0125787731340287; -0.46558337658875826 -0.8030437715739898 -0.34974036861563984; -0.2108086091693584 -0.6478653288753061 0.7078268252730086; -0.23804837089826317 0.9665624356241119 0.10430261464967631; 0.9440341570803235 -0.24778104274717402 -0.009780396910144639; -0.46382065345902734 0.8517748565773001 -0.13114106264902226; -0.548354725576806 0.674165595112357 -0.4331499615185582; 0.13938587994947232 0.08226642591739056 -0.9588712367131353; -0.9475763043545932 -0.2315210748340939 0.23135414581533675]

  # apply calib
  #@info size(data)
  for i=1:86
    data[:,i] = coordinateTrafo[i,:,:]*data[:,i]
  end
  #@info maximum(abs.(data))
  #@info size(data)
  #data = ones(3,86)
  if any(iszero.(data))
    @warn "Zero entries were found"
  end

  return MagSphereResult(timestamp, data)
end

function getXYZValues(gauss::MagSphere; tries = 10)
  discard(gauss.sd)
  i = 1
  while i < tries
    try 
      line = receive(gauss.sd)
      result = parseData(gauss, line)
      if !isnothing(result)
        return result.data
      end  
    catch e
      @debug e
    end
    i+=1
  end
  return nothing
end

close(gauss::MagSphere) = close(gauss.sd)
